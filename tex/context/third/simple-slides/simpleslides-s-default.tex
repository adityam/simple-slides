%D \module
%D   [      file=simpleslides-s-default,
%D        version=2007.07.15, 
%D          title=\CONTEXT\ Style File,
%D       subtitle=Presentation Module simpleslides --- Default style setup,
%D         author=Thomas A. Schmitz \& Aditya Mahajan,
%D           date=\currentdate,
%D      copyright={Thomas A. Schmitz}]
%C
%C Copyright 2007 Thomas A. Schmitz.
%C This file may be distributed under the GNU General Public License v. 2.0.

\writestatus{simpleslides}{loading default style setup}

\startmodule[simpleslides-s-default]

\unprotect

%D This module is the first sub-module that is loaded by
%D \filename{simpleslides}.  This sets up the style macros for the module. We
%D choose a rather plain style as the default; separate style sub-modules
%D redefine some internal macros to achieve fancier effects.


%D We start with the page layout. S6 has the ratio of a usual computer screen.

\setuppapersize[S6][S6]

%D We do not want page numbers, but we sometimes want to use the pagenumbering
%D mechanism, so we make sure pages are counted, but the numbers are not
%D displayed. 

\setuppagenumbering[location=]

%D As for the page layout: most of the numbers have been reached by
%D trial and error; I have just taken what seemed to produce the best output.

\setuplayout [width=fit,
              margin=0.6cm,
              height=fit, 
              header=0.15cm, 
              footer=1.35cm, 
	      footerdistance=0.5cm,
              topspace=0.5cm, 
              backspace=1cm,
              location=singlesided]


%D We define some other layouts which can be used to change the layout of
%D specific kinds of pages. This module defines three kinds of pages:
%D horizontal, vertical, and title, and we allow the possibility of changing the
%D layout of all three page styles.

\definelayout [simpleslides:layout:horizontal]
\definelayout [simpleslides:layout:vertical]
\definelayout [simpleslides:layout:title]

%D We want colored presentations

\setupcolors[state=start]

%D And colored typesetting for \TEX\ code.

\definetype[typeTEX][option=color]

%D Presentations have relatively dense lines, we do not care about underfull
%D lines, but allow emergency stretch.

\setuptolerance[verytolerant,stretch] 

%D We use combinations for placing vertical pictures and text side by side, and
%D we want a distance of 1.1 cm between both.

\setupcombinations[distance=1.1cm]

%D Next we define some dimensions that are used as nominal values by other
%D macros and the user.

\define\NormalHeight        {.830\textheight}
\define\NormalWidth         {.476\textwidth}
\define\PictureFrameHeight  {.830\textheight}
\define\PictureFrameWidth   {.476\textwidth}

%D As we said before, the presentation consists of three kinds of pages: title,
%D horizontal, and vertical. Each page can have a different background; we can
%D switch to a specific background using
%D \starttyping
%D \setupPageBackground[horizontal]
%D \stoptyping

\def\setupPageBackground%
   {\dosingleargument\dosetupPageBackground}

\def\dosetupPageBackground[#1]%
  {\setups{simpleslides:background:#1}}

%D The backgrounds in all the styles are very similar. So, we define overlays to
%D capture the different features of the backgrounds, and then simply define the
%D overlays in different styles.

\defineoverlay[simpleslides:background:horizontal]
\defineoverlay[simpleslides:background:title]
\defineoverlay[simpleslides:background:vertical]
\defineoverlay[simpleslides:background:ornament]

\definelayer[simpleslides:layer:slidetitle]
    [\c!width=\paperwidth,
    \c!height=\paperheight]

%D A generic frame which is used for titles and other commands

\defineframed[simpleslides:framed]
             [frame=off,offset=0pt,
              top=\vss,bottom=\vss]

%D Now we define setups for specific backgrounds

\startsetups simpleslides:background:title
   \setuplayout[simpleslides:layout:title]
     \setupbackgrounds[\v!page]
        [background={simpleslides:background:title}]
\stopsetups

\startsetups simpleslides:background:horizontal
  \setuplayout[simpleslides:layout:horizontal]
  \setupbackgrounds[\v!page]
        [background={simpleslides:background:horizontal,
                     simpleslides:background:ornament,
                     simpleslides:layer:slidetitle}]
\stopsetups

\startsetups simpleslides:background:vertical
  \setuplayout[simpleslides:layout:vertical]
  \setupbackgrounds[\v!page]
        [background={simpleslides:background:vertical,
                     simpleslides:background:ornament}]
\stopsetups

%D We also define some fallbacks for presentation backgrounds.

\startsetups simpleslides:background:default
  \setups{simpleslides:background:horizontal}
\stopsetups

\startsetups simpleslides:background:none
  \setupbackgrounds[\v!page]
                   [background=]
\stopsetups

\startsetups simpleslides:background:empty
   \message{I don't know the name of the background you have provided.}
   \setups{simpleslides:background:horizontal}
\stopsetups
  
%D Now we move on to specific components of the presentation. The first thing in
%D any presentation is the title page, so we start with that. We define a macro
%D that stores values for the title, author and date of the presentation. These
%D are input as
%D \starttyping
%D \setupTitle[title={How to write a sub module for simpleslides},
%D             author={Aditya Mahajan},
%D             date={\currentdate[d=10,m=7,y=2008]}]
%D \stoptyping
%D This setup command can also setup the color and style for the title, author,
%D and date.

\def\setupTitle%
  {\dosingleargument\dosetupTitle}

\def\dosetupTitle[#1]%
  {\setupmodule[simpleslides:title][#1]}

%D A few macros to save some typing

\def\simpleslidestitleparameter%#1
  {\moduleparameter{simpleslides:title}}

\def\simpleslidestitlecomponent#1%
  {\simpleslidestitleparameter{\c!before#1}
      \startalignment[\simpleslidestitleparameter{#1\c!align}]
        \doattributes{\??md:simpleslides:title:}{#1\c!style}{#1\c!color}
          {\moduleparameter{simpleslides:title}{#1}}
       \stopalignment
    \simpleslidestitleparameter{\c!after#1}}

%D \macros{placeTitle}
%D
%D The macro \tex{placeTitle} produces a title page with the author, the
%D title of the presentation, and the date. Using it is not mandatory.

\define\placeTitle
  {\page
   \setupPageBackground[title]
   \null
   \simpleslidestitleparameter\c!before
   \startalignment[\simpleslidestitleparameter\c!align]
   \dostartattributes{\??md:simpleslides:title:}\c!headstyle\c!headcolor
    \simpleslidestitlecomponent\c!title
    \simpleslidestitlecomponent\c!author
    \simpleslidestitlecomponent\c!date
   \dostopattributes
   \stopalignment
   \simpleslidestitleparameter\c!after
   \page}

%D If a sub-module wants to display more information about the presentation
%D (e.g., institute of the author), it can be simply input as
%D \starttyping
%D   \setupTitle[institute={Some University}]
%D \stoptyping
%D This parameter can be accessed inside the module as
%D \type{\simpleslidestitleparameter{institute}}, and the module writer
%D can redefine \type{\placeTitle} to display the institute at the appropriate
%D place. 


%D Now we setup some default values for the title page. Other modules will
%D redefine these values later.

\setupTitle
  [\c!title=,
   \c!author=,
   \c!date=\currentdate,
   \c!style=,
   \c!color=red,
   \c!align=\v!middle,
   \c!before=\vfill,
   \c!after=\vfill,
   \c!title\c!style={\switchtobodyfont[\TitleSize]},
   \c!title\c!color=,
   \c!title\c!align=,%\v!middle,
   \c!author\c!style=,
   \c!author\c!color=,
   \c!author\c!align=,%\v!middle, 
   \c!date\c!style=,
   \c!date\c!color=,
   \c!date\c!align=,%\v!middle,
   \c!before\c!title=,
   \c!before\c!author=,
   \c!before\c!date=,
   \c!after\c!title={\blank[2*line]},
   \c!after\c!author={\blank[3*line]},
   \c!after\c!date=]

%D \macros{SlideTitle}
%D \tex{SlideTitle}: well, the name says it all. The
%D argument is typeset as the title, but the implementation and the result
%D (alignment, size, distance to text, color etc.) vary from module to module,
%D so this macro is defined in each of the submodules. 

\def\setupSlideTitle
  {\dosingleargument\dosetupSlideTitle}

\def\dosetupSlideTitle[#1]%
  {\setupmodule[simpleslides:slidetitle]
               [\c!alternative=\v!normal,\c!width=\textwidth,
                \c!height=2\lineheight,#1]}

\def\simpleslidesslidetitleparameter%#1
  {\moduleparameter{simpleslides:slidetitle}}

\def\defineSlideTitleAlternative
  {\dosingleargument\dodefineSlideTitleAlternative}

\def\dodefineSlideTitleAlternative[#1]% #2
  {\setvalue{simpleslides:slidetitle:#1}}

\defineSlideTitleAlternative[\v!normal]#1%
  {\page[\simpleslidesslidetitleparameter\c!page]%
   \simpleslidesslidetitleparameter\c!before
      \startalignment[\simpleslidesslidetitleparameter\c!align]
        \doattributes{\??md:simpleslides:slidetitle:}\c!style\c!color{#1}%
       \stopalignment
    \simpleslidesslidetitleparameter\c!after}

\defineSlideTitleAlternative[layer]#1%
  {\page[\simpleslidesslidetitleparameter\c!page]%
   \simpleslidesslidetitleparameter\c!before
   \setlayer[simpleslides:layer:slidetitle]%
     {\getvalue{simpleslides:framed}
        [\c!width=\simpleslidesslidetitleparameter\c!width,
        \c!height=\simpleslidesslidetitleparameter\c!height,
         \c!align=\simpleslidesslidetitleparameter\c!align]
        {\doattributes{\??md:simpleslides:slidetitle:}\c!style\c!color{#1}}}%
    \simpleslidesslidetitleparameter\c!after}


%D Now the main user command

\def\SlideTitle{\dowithpargument\doSlideTitle}

\def\doSlideTitle% #1
  {\getvalue{simpleslides:slidetitle:\simpleslidesslidetitleparameter{alternative}}}

\setupSlideTitle
  [\c!page=\v!yes,
   \c!style={\switchtobodyfont[\TitleSize]},
   \c!before={\setupPageBackground[horizontal]},
   \c!after={\blank[0.75cm]},
   \c!align=\v!middle,
   \c!alternative=\v!normal]


%AM: Clean this up later.

%D \macros{IncludePicture}
%D The macros for placing pictures. This section has been entirely rewritten in
%D order to provide a cleaner user interface and to make the code easier to
%D maintain. We now have just one macro, \tex{IncludePicture}, which
%D automatically inserts page breaks and adjusts the background and margins, if
%D necessary. This macro takes four arguments: 
%D \setup{IncludePicture} 
%D The first argument decides whether the picture will be place in a horizontal
%D or vertical arrangement; the second argument is the filename of the picture
%D you want to include; the third argument does some setup, and the fourth
%D argument (in braces) is the text accompanying the picture, which will be
%D placed either in a \tex{SlideTitle} environment (for horizontal pictures) or
%D opposite the picture, centered horizontally and vertically, for vertical
%D pictures.
%D
%D This quite a big macro, so I document everything (as much for my own benefit
%D as for others who might look into the source ;-)

%D We will be using a metapost graphic "HighlightSomething" which takes some
%D variables. We set them up here to make sure that everything is properly
%D initialized; these values will later be overwritten by the values supplied
%D by user input.
\setupMPvariables[HighlightSomething][tasscale=20mm,x=3,y=3,x2=0,y2=0,x3=0,y3=0,x4=0,y4=0,x5=0,y5=0,tasgrid=0,tashigh=0,tasform=1,opacity=60,direction=75,direction2=75,direction3=75,direction4=75,direction5=75]
%D The user macro takes three arguments in brackets + an additional argument
%D for typeset content. So we define it in two steps:

\def\IncludePicture%
   {\dotripleargument\doIncludePicture}

%D Now comes the definition of the real macro. Watch out, it's complex!

\def\doIncludePicture[#1][#2][#3]#4%
%D First, we define a namespace for the key = value assignments in the third
%D argument and initialize them.
  {\getparameters[HLP][width=0,height=0,highlight=,highlightform=,highlightcolor=,showgrid=,gridcolor=,scale=1mm,direction=,opacity=,#3]%
%D Now we process these values one by one. "highlight," "highlightform," and
%D "showgrid" all set the numeric value of \tex{MPvariable}s which will later
%D be used for "if" tests in the metapost figure itself.
    \expandafter\processaction\expandafter[\HLPhighlight]%
                [\v!yes=>{\setupMPvariables[HighlightSomething][tashigh=1]},
                  \v!no=>{\setupMPvariables[HighlightSomething][tashigh=0]},
             \v!unknown=>{\setupMPvariables[HighlightSomething][tashigh=0]},
             \v!default=>{\setupMPvariables[HighlightSomething][tashigh=0]}]%
    \expandafter\processaction\expandafter[\HLPhighlightform]%
                [circle=>{\setupMPvariables[HighlightSomething][tasform=1]},
                  arrow=>{\setupMPvariables[HighlightSomething][tasform=2]},
                   gray=>{\setupMPvariables[HighlightSomething][tasform=3]},
             \v!unknown=>{\setupMPvariables[HighlightSomething][tasform=1]},
             \v!default=>{\setupMPvariables[HighlightSomething][tasform=1]}]%
    \expandafter\processaction\expandafter[\HLPshowgrid]%
                [\v!yes=>{\setupMPvariables[HighlightSomething][tasgrid=1]},
                  \v!no=>{\setupMPvariables[HighlightSomething][tasgrid=0]},
             \v!unknown=>{\setupMPvariables[HighlightSomething][tasgrid=0]},
             \v!default=>{\setupMPvariables[HighlightSomething][tasgrid=0]}]%
%D "highlightcolor" and "gridcolor" simply define colors.
    \expandafter\processaction\expandafter[\HLPhighlightcolor]%
            [\v!unknown=>{\definecolor[tashighlightcolor][\HLPhighlightcolor]},
             \v!default=>{\definecolor[tashighlightcolor][red]
                          \message{You haven't set a highlightcolor. I have chosen "red" for you.}}]%
    \expandafter\processaction\expandafter[\HLPgridcolor]%
            [\v!unknown=>{\definecolor[tasgridcolor][\HLPgridcolor]},
             \v!default=>{\definecolor[tasgridcolor][black]
                         \message{You haven't set a gridcolor. I have chosen "black" for you.}}]%
%D "scale" can be either a dimension or a number (in which case the default
%D unit is "mm"). So we first test whether it's a dimension; if it isn't, we
%D test whether it's a number, and append "mm." If it isn't a number, we set an
%D absurd value and warn the user.
    \doifdimensionelse\HLPscale
       {\setupMPvariables[HighlightSomething][tasscale=\HLPscale]}% 
       {\doifnumberelse\HLPscale
         {\setupMPvariables[HighlightSomething][tasscale=\HLPscale mm]}%
         {\message{The value you have provided for the "scale" parameter is not a dimension. Please specify the scale!}\setupMPvariables[HighlightSomething][tasscale=1mm]}}%
%D We define an overlay which uses the MPgraphic.
    \defineoverlay[simpleslides:background:highlight][\useMPgraphic{HighlightSomething}{#3}]%
%D And finally, we process the keyword in argument [#1]. If it is "vertical,"
%D we set up a vertical slide; default is "horizontal." Both forms use the
%D overlay we have just defined as a layer which will be placed on top of the
%D picture. Breaking the page, switching of background,
%D placing the text is all wrapped into this macro. 
    \processaction[#1]
      [\v!horizontal=>{\doIncludePictureHorizontal[#2]{#4}},
         \v!vertical=>{\doIncludePictureVertical[#2]{#4}},
          \v!default=>{\doIncludePictureHorizontal[#2]{#4}},
          \v!unknown=>{\doIncludePictureHorizontal[#2]{#4}}%
                       \message{Keywords for positioning pictures are
                         "horizontal" or "vertical." 
                          Please specify one of them!}]}

%D We have to set the width
%D or height for vertical and horizontal pictures separately. We test if the
%D user has supplied values for the "width" and "height" key or if there are
%D still at their default of "0." If they have been set, these are used for
%D the width/height of the picture. If they are still 0, we determine the
%D ratio of the picture and let it fill the available space. Small pictures
%D will be enlarged, big pictures will be fit. This code was suggested by
%D Wolfgang Schuster on the mailing list.
\def\setPictureDimensionsTo#1#2% graphic width 
  {\doifelse\HLPwidth{0}
     {\doifelse\HLPheight{0}%
      {\bgroup
       \setbox\scratchbox\hbox{\externalfigure[#1]}
       \!!dimena\ht\scratchbox%
       \!!dimenb\wd\scratchbox%
       \!!dimena\dimexpr\PictureFrameHeight/\!!dimena\relax
       \!!dimenb\dimexpr#2/\!!dimenb\relax
       \ifdim\!!dimena>\!!dimenb
          \gdef\PICwidth{#2}
          \gdef\PICheight{}
       \else%
          \gdef\PICwidth{}
          \gdef\PICheight{\NormalHeight}
       \fi\egroup}%
      {\def\PICwidth{}
       \def\PICheight{\HLPheight}}}
    {\def\PICwidth{\HLPwidth}
     \def\PICheight{}}}

%AM: A better name?
\def\fancyPictureFrame[#1]#2%
  {\framed[\c!frame=\v!on,
		framecolor=green,
          \c!align=\v!middle,
          \c!top=\vss,
          \c!bottom=\vss,
          \c!strut=\v!no,
          \c!offset=\zeropoint,#1]
      {\framed[\c!frame=\v!on,
		framecolor=red,
               \c!strut=\v!no,
               \c!offset=\zeropoint,
               \c!width=\v!fit,
               \c!height=\v!fit,
               \c!background={foreground,simpleslides:background:highlight}]
      {#2}}}


\def\doIncludePictureHorizontal[#1]#2% graphic text
 {\setPictureDimensionsTo{#1}\textwidth
  \SlideTitle{#2}%
  \fancyPictureFrame
    [\c!width=\textwidth,
     \c!height=\PictureFrameHeight]
    {\externalfigure[#1][\c!height=\PICheight,\c!width=\PICwidth]}}

\def\doIncludePictureVertical[#1]#2% graphic text
  {\setPictureDimensionsTo{#1}\NormalWidth
    \page
    \setupPageBackground[vertical]
    \startcombination[2]
      {\fancyPictureFrame
        [\c!height=\textheight,
         \c!width=\PictureFrameWidth]
         {\externalfigure[#1][\c!width=\PICwidth,\c!height=\PICheight]}}{}
       {\framed[\c!frame=\v!off,
                \c!height=\textheight,
                \c!width=\PictureFrameWidth,
                \c!top=\vss,
                \c!bottom=\vss,
                \c!align=\v!middle,
                \c!strut=\v!no]{#2}}{}
    \stopcombination}
      
%D Now we define the MPgraphic for the overlay. Initially, it contains just an
%D empty box to the dimensions of the frame into which it is put. Then, it
%D performs a couple of tests: it includes other MPgraphics, depending on the
%D value of \tex{MPvars} which we have set by processing the assignments in the
%D \tex{IncludePicture} macro. If "highlight" is set to yes and if "showgrid"
%D is set to yes, the metapost grid is included; then, depending on the value
%D of the \tex{MPvar} "tasform," one of the other highlighting MPgraphics.  The
%D grid facilitates the precise positioning of the highlighted areas. This is
%D an idea Taco suggested at the \CONTEXT\ meeting at Bohinj.  The code for the
%D gray overlay has been contributed by Wolfgang Schuster and Peter Rolf.  The
%D original code for the circle was contributed by Mojca. Thanks to all of
%D them!

\startuseMPgraphic{HighlightSomething}{tashigh,tasscale,x,y,x2,y2,x3,y3,x4,y4,x5,y5,opacity,direction,direction2,direction3,direction4,direction5,tasgrid}
path HLPbdg ; 
HLPbdg := unitsquare xyscaled(OverlayWidth,OverlayHeight) ;
if \MPvar{tashigh} = 1:
   if \MPvar{tasgrid} = 1 :
	\includeMPgraphic{ShowGrid}
   fi ;
   if \MPvar{tasform} = 1 :
	\includeMPgraphic{HighCircle} ;
   elseif \MPvar{tasform} = 2 :
	\includeMPgraphic{HighArrow} ;
   elseif \MPvar{tasform} = 3 :
	\includeMPgraphic{HighGray} ;
   fi ;
fi ;
setbounds currentpicture to HLPbdg ;
\stopuseMPgraphic

\startuseMPgraphic{HighCircle}{tasscale,x,y,x2,y2,x3,y3,x4,y4,x5,y5,direction,direction2,direction3,direction4,direction5}
for i=1 upto 18:
 	pickup pencircle scaled (i*0.333pt) ;
 	draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x}mm + 1.5mm,\MPvar{y}mm - 1.5mm) withcolor transparent (1,0.025,black) ;
 endfor ;
pickup pencircle scaled 5pt ;
draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x}mm,\MPvar{y}mm) withcolor \MPcolor{tashighlightcolor} ;
if \MPvar{x2} <> 0:
	for i=1 upto 18:
 		pickup pencircle scaled (i*0.333pt) ;
 		draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x2}mm + 1.5mm,\MPvar{y2}mm - 1.5mm) withcolor transparent (1,0.025,black) ;
	 endfor ;
	pickup pencircle scaled 5pt ;
	draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x2}mm,\MPvar{y2}mm) withcolor \MPcolor{tashighlightcolor} ;
fi ;
if \MPvar{x3} <> 0:
	for i=1 upto 18:
 		pickup pencircle scaled (i*0.333pt) ;
 		draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x3}mm + 1.5mm,\MPvar{y3}mm - 1.5mm) withcolor transparent (1,0.025,black) ;
	 endfor ;
	pickup pencircle scaled 5pt ;
	draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x3}mm,\MPvar{y3}mm) withcolor \MPcolor{tashighlightcolor} ;
fi ;
if \MPvar{x4} <> 0:
	for i=1 upto 18:
 		pickup pencircle scaled (i*0.333pt) ;
 		draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x4}mm + 1.5mm,\MPvar{y4}mm - 1.5mm) withcolor transparent (1,0.025,black) ;
	 endfor ;
	pickup pencircle scaled 5pt ;
	draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x4}mm,\MPvar{y4}mm) withcolor \MPcolor{tashighlightcolor} ;
fi ;
if \MPvar{x5} <> 0:
	for i=1 upto 18:
 		pickup pencircle scaled (i*0.333pt) ;
 		draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x5}mm + 1.5mm,\MPvar{y5}mm - 1.5mm) withcolor transparent (1,0.025,black) ;
	 endfor ;
	pickup pencircle scaled 5pt ;
	draw fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x5}mm,\MPvar{y5}mm) withcolor \MPcolor{tashighlightcolor} ;
fi ;
setbounds currentpicture to HLPbdg ;
\stopuseMPgraphic

\startuseMPgraphic{HighArrow}{direction,x,y,x2,y2,x3,y3,x4,y4,x5,y5}
pair arrowtip, arrowbase, shiftedtip, shiftedbase ;
arrowtip := (\MPvar{x}mm,\MPvar{y}mm) ;
arrowbase := arrowtip + 2.5cm*dir(\MPvar{direction}) ;
shiftedtip := arrowtip shifted (1.5mm,-1.5mm) ;
shiftedbase := arrowbase shifted (1.5mm,-1.5mm) ;
for i=1 upto 18:
	ahlength := (i*0.833pt) ;
	pickup pencircle scaled (i*0.277pt) ;
	drawarrow shiftedbase -- shiftedtip withcolor transparent (1,0.025,black) ;
endfor ;
ahlength := 15pt ;
pickup pencircle scaled 5pt ;
drawarrow arrowbase -- arrowtip withcolor \MPcolor{tashighlightcolor} ;
if \MPvar{x2} <> 0:
   arrowtip := (\MPvar{x2}mm,\MPvar{y2}mm) ;
   arrowbase := arrowtip + 2.5cm*dir(\MPvar{direction2}) ;
   shiftedtip := arrowtip shifted (1.5mm,-1.5mm) ;
   shiftedbase := arrowbase shifted (1.5mm,-1.5mm) ;
   for i=1 upto 18:
   	ahlength := (i*0.833pt) ;
   	pickup pencircle scaled (i*0.277pt) ;
   	drawarrow shiftedbase -- shiftedtip withcolor transparent (1,0.025,black) ;
   endfor ;
   ahlength := 15pt ;
   pickup pencircle scaled 5pt ;
   drawarrow arrowbase -- arrowtip withcolor \MPcolor{tashighlightcolor} ;
fi ;
if \MPvar{x3} <> 0:
   arrowtip := (\MPvar{x3}mm,\MPvar{y3}mm) ;
   arrowbase := arrowtip + 2.5cm*dir(\MPvar{direction3}) ;
   shiftedtip := arrowtip shifted (1.5mm,-1.5mm) ;
   shiftedbase := arrowbase shifted (1.5mm,-1.5mm) ;
   for i=1 upto 18:
   	ahlength := (i*0.833pt) ;
   	pickup pencircle scaled (i*0.277pt) ;
   	drawarrow shiftedbase -- shiftedtip withcolor transparent (1,0.025,black) ;
   endfor ;
   ahlength := 15pt ;
   pickup pencircle scaled 5pt ;
   drawarrow arrowbase -- arrowtip withcolor \MPcolor{tashighlightcolor} ;
fi ;
if \MPvar{x4} <> 0:
   arrowtip := (\MPvar{x4}mm,\MPvar{y4}mm) ;
   arrowbase := arrowtip + 2.5cm*dir(\MPvar{direction4}) ;
   shiftedtip := arrowtip shifted (1.5mm,-1.5mm) ;
   shiftedbase := arrowbase shifted (1.5mm,-1.5mm) ;
   for i=1 upto 18:
   	ahlength := (i*0.833pt) ;
   	pickup pencircle scaled (i*0.277pt) ;
   	drawarrow shiftedbase -- shiftedtip withcolor transparent (1,0.025,black) ;
   endfor ;
   ahlength := 15pt ;
   pickup pencircle scaled 5pt ;
   drawarrow arrowbase -- arrowtip withcolor \MPcolor{tashighlightcolor} ;
fi ;
if \MPvar{x5} <> 0:
   arrowtip := (\MPvar{x5}mm,\MPvar{y5}mm) ;
   arrowbase := arrowtip + 2.5cm*dir(\MPvar{direction5}) ;
   shiftedtip := arrowtip shifted (1.5mm,-1.5mm) ;
   shiftedbase := arrowbase shifted (1.5mm,-1.5mm) ;
   for i=1 upto 18:
   	ahlength := (i*0.833pt) ;
   	pickup pencircle scaled (i*0.277pt) ;
   	drawarrow shiftedbase -- shiftedtip withcolor transparent (1,0.025,black) ;
   endfor ;
   ahlength := 15pt ;
   pickup pencircle scaled 5pt ;
   drawarrow arrowbase -- arrowtip withcolor \MPcolor{tashighlightcolor} ;
fi ;
setbounds currentpicture to HLPbdg ;
\stopuseMPgraphic

\startuseMPgraphic{HighGray}{opacity,tasscale,x,y}
op := \MPvar{opacity}/100 ;
path Gfrg ;
Gfrg := fullcircle scaled \MPvar{tasscale} shifted (\MPvar{x}mm,\MPvar{y}mm) ;
fill HLPbdg--reverse Gfrg--cycle withcolor transparent (1,op,black) ;
\stopuseMPgraphic

\startuseMPgraphic{ShowGrid}
defaultscale := 0.9 ;
path gridenl ;
pair rightedge ; rightedge = urcorner HLPbdg ;
gridenl := HLPbdg enlarged (0.65cm,0.65cm) ;
pair ztasgridy[] ; 
pair ztasgridx[] ;
numeric gridmeasure ; gridmeasure = 5mm ;
path VertGrid ; VertGrid = (0,0) -- (0,12cm) ;
path HorGrid ; HorGrid = (0,0) -- (19cm,0) ;
pickup pencircle scaled 0.1pt ;
for tasi = 0 upto 38:
	draw VertGrid shifted (tasi * gridmeasure,0) withcolor \MPcolor{tasgridcolor} ;
endfor ;
for tasi = 0 upto 24:
	draw HorGrid shifted (0,tasi * gridmeasure) withcolor \MPcolor{tasgridcolor} ;
endfor ;
pickup pencircle scaled 1pt ;
for tasi = 2 step 2 until 38:
	gridvalue := tasi * 5 ;
	draw VertGrid shifted (tasi * gridmeasure,0) withcolor \MPcolor{tasgridcolor} ;
endfor ;
for tasi = 2 step 2 until 24:
	gridvalue := tasi * 5 ;
	draw HorGrid shifted (0,tasi * gridmeasure) withcolor \MPcolor{tasgridcolor} ;
endfor ;
clip currentpicture to HLPbdg ;
for tasi = 2 step 2 until 22:
 	gridvalue := tasi * 5 ;
 	ztasgridy[tasi] := (0,tasi * gridmeasure) ;
 	label.rt(decimal gridvalue,(xpart rightedge, ypart ztasgridy[tasi])) ;
	ztasgridy[tasi] := (0,tasi * gridmeasure) ;
	label.lft(decimal gridvalue,ztasgridy[tasi]) ;
endfor ;
for tasi = 2 step 2 until 36:
  	gridvalue := tasi * 5 ;
	ztasgridx[tasi] := (tasi * gridmeasure,OverlayHeight) ;
	label.top(decimal gridvalue,ztasgridx[tasi]) ;
  	ztasgridx[tasi] := (tasi * gridmeasure,0) ;
  	label.bot(decimal gridvalue,ztasgridx[tasi]) ;
endfor ;
clip currentpicture to gridenl ;
\stopuseMPgraphic

%D This is a small square which will be used for itemizations; it will be
%D placed in the margin. 

\startuniqueMPgraphic{simpleslides:itemize:triangle}
  fill (0,0) -- (0,0.4cm) -- (0.6cm,0.2cm) -- cycle 
       withcolor \MPcolor{simpleslides:itemize:color} ;
\stopuniqueMPgraphic

\startuniqueMPgraphic{simpleslides:itemize:square}
  fill unitsquare xyscaled(0.4cm,0.4cm) 
       withcolor \MPcolor{simpleslides:itemize:color} ;
\stopuniqueMPgraphic


\protect

\stopmodule
